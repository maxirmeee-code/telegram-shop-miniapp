<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - CalaisWeed</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; }
    input, textarea, button { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
    button { background: #25D366; color: white; border: none; cursor: pointer; }
    .product { border: 1px solid #eee; padding: 10px; margin: 10px 0; border-radius: 8px; }
    .delete { background: red; color: white; padding: 5px 10px; border: none; border-radius: 50%; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Panel Admin</h1>
    <input type="password" id="password" placeholder="Mot de passe" />
    <button onclick="login()">Connexion</button>

    <div id="admin-panel" style="display:none;">
      <h2>Ajouter un produit</h2>
      <input id="name" placeholder="Nom" />
      <textarea id="desc" placeholder="Description"></textarea>
      <input id="image" placeholder="URL Image" />
      <input id="category" placeholder="Cat√©gorie (Fleurs, Hash, Chimie)" />
      <div id="options">
        <div class="option">
          <input placeholder="Poids (ex: 1g)" class="weight" />
          <input placeholder="Prix (‚Ç¨)" class="price" type="number" />
        </div>
      </div>
      <button onclick="addOption()">+ Option</button>
      <button onclick="saveProduct()">Sauvegarder</button>

      <h2>Produits actuels</h2>
      <div id="list"></div>
    </div>
  </div>

  <script>
    const PASSWORD = "calaisweed2025"; // ‚Üê CHANGE √áA !
    let products = [];

    function login() {
      if (document.getElementById('password').value === PASSWORD) {
        document.getElementById('admin-panel').style.display = 'block';
        loadProducts();
      } else {
        alert("Mot de passe incorrect");
      }
    }

    function addOption() {
      const div = document.createElement('div');
      div.className = 'option';
      div.innerHTML = `
        <input placeholder="Poids (ex: 1g)" class="weight" />
        <input placeholder="Prix (‚Ç¨)" class="price" type="number" />
      `;
      document.getElementById('options').appendChild(div);
    }

    async function loadProducts() {
      const res = await fetch('/products.json');
      products = await res.json();
      renderList();
    }

    function renderList() {
      const list = document.getElementById('list');
      list.innerHTML = products.map((p, i) => `
        <div class="product">
          <strong>${p.name}</strong> (${p.category})<br>
          <small>${p.description}</small><br>
          <button class="delete" onclick="deleteProduct(${i})">√ó</button>
        </div>
      `).join('');
    }

    function saveProduct() {
      const name = document.getElementById('name').value;
      const desc = document.getElementById('desc').value;
      const image = document.getElementById('image').value;
      const category = document.getElementById('category').value;

      const options = Array.from(document.querySelectorAll('.option')).map(div => ({
        weight: div.querySelector('.weight').value,
        price: +div.querySelector('.price').value
      })).filter(o => o.weight && o.price);

      if (!name || !category || options.length === 0) {
        alert("Remplis tout !");
        return;
      }

      products.push({ name, description: desc, image, category, options });
      saveToGitHub();
    }

    function deleteProduct(i) {
      products.splice(i, 1);
      saveToGitHub();
    }

    async function saveToGitHub() {
      const token = prompt("Token GitHub (g√©n√®re sur github.com/settings/tokens) :");
      if (!token) return;

      const content = btoa(JSON.stringify(products, null, 2));
      const res = await fetch('https://api.github.com/repos/Mac524221189153/telegram-shop-miniapp/contents/web/products.json', {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'Mise √† jour produits',
          content: content,
          sha: await getSHA()
        })
      });

      if (res.ok) {
        alert("Produit sauvegard√© ! Vercel red√©ploie dans 30s");
        renderList();
      } else {
        alert("Erreur GitHub");
      }
    }

    async function getSHA() {
      const res = await fetch('https://api.github.com/repos/Mac524221189153/telegram-shop-miniapp/contents/web/products.json');
      const data = await res.json();
      return data.sha;
    }
  </script>
</body>
</html>