<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - CalaisWeed</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, textarea, button { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    button { background: #25D366; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: #1da851; }
    .product { border: 1px solid #eee; padding: 12px; margin: 12px 0; border-radius: 8px; background: #f9f9f9; }
    .delete { background: #e74c3c; color: white; padding: 6px 12px; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; float: right; }
    .option { display: flex; gap: 10px; margin: 8px 0; }
    .option input { width: 48%; }
    .clear { clear: both; }
    #status { margin-top: 10px; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Panel Admin</h1>
    <input type="password" id="password" placeholder="Mot de passe" />
    <button onclick="login()">Connexion</button>

    <div id="admin-panel" style="display:none;">
      <h2>Ajouter un produit</h2>
      <input id="name" placeholder="Nom du produit" />
      <textarea id="desc" placeholder="Description détaillée"></textarea>
      <input id="image" placeholder="URL de l'image (ex: https://image.noelshack.com/...)" />
      <input id="category" placeholder="Catégorie (Fleurs, Hash, Chimie)" />
      
      <h3>Options de poids/prix</h3>
      <div id="options">
        <div class="option">
          <input placeholder="Poids (ex: 1g8)" class="weight" />
          <input placeholder="Prix (€)" class="price" type="number" />
        </div>
      </div>
      <button onclick="addOption()" style="background:#4CAF50; margin:10px 0;">+ Ajouter une option</button>
      <button onclick="saveProduct()" style="background:#2196F3;">Sauvegarder le produit</button>

      <div id="status"></div>

      <h2 style="margin-top:30px;">Produits actuels</h2>
      <div id="list"></div>
    </div>
  </div>

  <script>
    const PASSWORD = "calaisweed2025"; // CHANGE CE MOT DE PASSE !
    const REPO_OWNER = "maxirmeee-code"; // ← FIXÉ (ton vrai owner)
    const REPO_NAME = "telegram-shop-miniapp"; // ← Fixé
    const FILE_PATH = "web/products.json"; // ← Fixé
    let products = [];

    function login() {
      const input = document.getElementById('password').value;
      if (input === PASSWORD) {
        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('password').value = '';
        loadProducts();
      } else {
        alert("Mot de passe incorrect !");
      }
    }

    function addOption() {
      const div = document.createElement('div');
      div.className = 'option';
      div.innerHTML = `
        <input placeholder="Poids (ex: 1g8)" class="weight" />
        <input placeholder="Prix (€)" class="price" type="number" />
      `;
      document.getElementById('options').appendChild(div);
    }

    // CHARGE LES PRODUITS DEPUIS products.json
    async function loadProducts() {
      try {
        const res = await fetch('/products.json?t=' + Date.now()); // Cache busting
        if (!res.ok) throw new Error("Fichier non trouvé");
        products = await res.json();
        renderList();
      } catch (err) {
        document.getElementById('status').innerHTML = `<p class="error">Erreur chargement: ${err.message}</p>`;
        products = [];
        renderList();
      }
    }

    // AFFICHE LA LISTE
    function renderList() {
      const list = document.getElementById('list');
      if (products.length === 0) {
        list.innerHTML = "<p style='color:#999; text-align:center;'>Aucun produit</p>";
        return;
      }
      list.innerHTML = products.map((p, i) => `
        <div class="product">
          <strong>${p.name}</strong> <small>(${p.category})</small>
          <button class="delete" onclick="deleteProduct(${i})">×</button>
          <div class="clear"></div>
          <small style="color:#666;">${p.description}</small>
          ${p.image ? `<br><img src="${p.image}" style="width:100%; max-height:120px; object-fit:cover; border-radius:8px; margin:8px 0;">` : ''}
          <div style="margin-top:8px; font-size:13px;">
            <strong>Options :</strong> 
            ${p.options.map(o => `${o.weight} → ${o.price}€`).join(' | ')}
          </div>
        </div>
      `).join('');
    }

    // SAUVEGARDE NOUVEAU PRODUIT
    function saveProduct() {
      const name = document.getElementById('name').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const image = document.getElementById('image').value.trim();
      const category = document.getElementById('category').value.trim();

      const options = Array.from(document.querySelectorAll('.option')).map(div => ({
        weight: div.querySelector('.weight').value.trim(),
        price: parseFloat(div.querySelector('.price').value)
      })).filter(o => o.weight && !isNaN(o.price));

      if (!name || !category || options.length === 0) {
        document.getElementById('status').innerHTML = '<p class="error">Remplis tous les champs obligatoires !</p>';
        return;
      }

      products.push({ name, description: desc, image, category, options });
      clearForm();
      saveToGitHub("Ajout produit: " + name);
    }

    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('desc').value = '';
      document.getElementById('image').value = '';
      document.getElementById('category').value = '';
      document.getElementById('options').innerHTML = `
        <div class="option">
          <input placeholder="Poids (ex: 1g8)" class="weight" />
          <input placeholder="Prix (€)" class="price" type="number" />
        </div>
      `;
    }

    // SUPPRESSION
    function deleteProduct(i) {
      if (confirm(`Supprimer "${products[i].name}" ?`)) {
        products.splice(i, 1);
        saveToGitHub("Suppression produit: " + products[i]?.name || "inconnu");
      }
    }

    // SAUVEGARDE SUR GITHUB (FIXÉ AVEC OWNER CORRIGÉ)
    async function saveToGitHub(message) {
      const token = prompt("Token GitHub (doit avoir 'repo' scope) :");
      if (!token?.trim()) return;

      const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
      console.log("API URL:", apiUrl); // DEBUG

      try {
        // RÉCUPÈRE LE SHA ACTUEL (gestion 404)
        let sha = null;
        try {
          const shaRes = await fetch(apiUrl, {
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json',
              'X-GitHub-Api-Version': '2022-11-28',
              'User-Agent': 'CalaisWeed-Admin'
            }
          });
          if (shaRes.ok) {
            const data = await shaRes.json();
            sha = data.sha;
          } else if (shaRes.status !== 404) {
            const err = await shaRes.json();
            throw new Error(`Erreur SHA: ${shaRes.status} - ${err.message}`);
          }
        } catch (shaErr) {
          if (shaErr.message.includes('404')) {
            console.log("Fichier n'existe pas → création");
          } else {
            throw shaErr;
          }
        }

        // ENCODE LE JSON (UTF-8 fixe)
        const jsonString = JSON.stringify(products, null, 2);
        const content = btoa(unescape(encodeURIComponent(jsonString)));

        // ENVOIE LA MISE À JOUR (AVEC COMMITTER)
        const putRes = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'X-GitHub-Api-Version': '2022-11-28',
            'Content-Type': 'application/json',
            'User-Agent': 'CalaisWeed-Admin'
          },
          body: JSON.stringify({
            message: message || 'Mise à jour produits via admin',
            content: content,
            sha: sha,
            committer: {
              name: "Admin CalaisWeed",
              email: "admin@calaisweed.fr"
            }
          })
        });

        if (putRes.ok) {
          document.getElementById('status').innerHTML = '<p class="success">Sauvegardé avec succès ! Vercel redéploie dans 30s</p>';
          renderList();
        } else {
          const err = await putRes.json();
          document.getElementById('status').innerHTML = `<p class="error">Erreur GitHub: ${err.message || putRes.statusText} (Status: ${putRes.status})</p>`;
          console.error('GitHub Error:', err);
        }
      } catch (err) {
        document.getElementById('status').innerHTML = `<p class="error">Erreur réseau: ${err.message}</p>`;
        console.error('Save Error:', err);
      }
    }
  </script>
</body>
</html>